import streamlit as st
import folium
from folium import GeoJson
import json
from io import BytesIO
import random

# Configuraci칩n de la p치gina con t칤tulo y emoji de mundo
st.set_page_config(page_title="Mapa del Gasto P칰blico en Per칰 游깴", page_icon="游깴", layout="wide")

# Diccionario de colores para cada departamento
departamento_colores = {
    "AMAZONAS": "#FF6347",
    "ANCASH": "#32CD32",
    "APURIMAC": "#1E90FF",
    "AREQUIPA": "#FFD700",
    "AYACUCHO": "#8A2BE2",
    "CAJAMARCA": "#FF4500",
    "CALLAO": "#20B2AA",
    "CUSCO": "#D2691E",
    "HUANCAVELICA": "#ADFF2F",
    "HUANUCO": "#FF1493",
    "ICA": "#B8860B",
    "JUNIN": "#A52A2A",
    "LA LIBERTAD": "#A9A9A9",
    "LAMBAYEQUE": "#7FFF00",
    "LIMA": "#800000",
    "LORETO": "#9ACD32",
    "MADRE DE DIOS": "#4B0082",
    "MOQUEGUA": "#8B0000",
    "PASCO": "#2E8B57",
    "PIURA": "#B0C4DE",
    "PUNO": "#FF8C00",
    "SAN MARTIN": "#E0FFFF",
    "TACNA": "#00CED1",
    "TUMBES": "#FF00FF",
    "UCAYALI": "#F08080"
}


# Cargar archivo GeoJSON
@st.cache_data
def load_geojson():
    with open("peru_departamental_simple.geojson", "r") as f:
        geojson_data = json.load(f)
    return geojson_data


# Crear el mapa interactivo
def create_map(geojson_data, selected_departamento=None):
    m = folium.Map(location=[-9.19, -75.015], zoom_start=5)

    # Funci칩n para manejar el clic en un departamento
    def handle_click(feature):
        departamento = feature['properties']['NOMBDEP']
        gasto_mensual = [random.randint(500000, 2000000) for _ in range(12)]
        st.session_state["departamento"] = departamento
        st.session_state["gasto_mensual"] = gasto_mensual

    # A침adir cada departamento al mapa
    for feature in geojson_data["features"]:
        dep_name = feature['properties']['NOMBDEP']
        color = departamento_colores.get(dep_name, "#808080")

        # Cambiar el contorno si es el departamento seleccionado
        if dep_name == selected_departamento:
            line_color = "yellow"  # Contorno resaltado para el departamento seleccionado
            weight = 4
        else:
            line_color = "black"
            weight = 2

        folium.GeoJson(
            feature,
            style_function=lambda feature, color=color: {
                'fillColor': color,
                'weight': weight,
                'opacity': 1,
                'color': line_color,
                'fillOpacity': 0.7
            },
            tooltip=feature['properties']['NOMBDEP'],
            highlight_function=lambda x: {'weight': 3, 'color': 'blue'},
            name="Departamento",
        ).add_to(m)

    map_html = BytesIO()
    m.save(map_html, close_file=False)
    map_html.seek(0)
    return map_html


# T칤tulo de la aplicaci칩n
st.title("Mapa Interactivo del Gasto P칰blico en Per칰 - A침o 2023 游깴")

# Columnas de la interfaz
col1, col2 = st.columns([1, 2], gap="medium")

# Columna Izquierda: Informaci칩n de Gasto
with col1:
    st.header("Informaci칩n de Gasto P칰blico 游늵")

    # Mostrar los datos al hacer clic
    if "departamento" in st.session_state:
        departamento = st.session_state["departamento"]
        gasto_mensual = st.session_state["gasto_mensual"]

        st.subheader(f"Departamento: {departamento}")
        st.markdown("<hr style='border:1px solid #ddd;'>", unsafe_allow_html=True)

        st.write("### Gasto Mensual (S/):")
        for mes, gasto in enumerate(gasto_mensual, start=1):
            st.write(f"**Mes {mes}**: S/ {gasto:,.2f}")

        total_gasto = sum(gasto_mensual)
        st.markdown("<hr style='border:1px solid #ddd;'>", unsafe_allow_html=True)
        st.write(f"**Gasto Total Anual:** S/ {total_gasto:,.2f}")
    else:
        st.write("Seleccione una regi칩n en el mapa para ver el detalle del gasto p칰blico.")

# Columna Derecha: Mapa Interactivo
with col2:
    geojson_data = load_geojson()
    map_html = create_map(geojson_data, selected_departamento=st.session_state.get("departamento"))
    st.components.v1.html(map_html.getvalue(), height=600)

# Barra lateral con informaci칩n adicional
st.sidebar.header("Informaci칩n Adicional")
st.sidebar.markdown("""
    Este mapa muestra el gasto p칰blico por departamento en Per칰 para el a침o 2023.
    <br>Haga clic en cualquier regi칩n para obtener detalles espec칤ficos de cada 치rea.
    <br><br>Este proyecto fue desarrollado como una herramienta de visualizaci칩n de datos para el an치lisis regional.
    """, unsafe_allow_html=True)

# Notificaci칩n para el usuario
st.sidebar.info("Haga clic en un departamento en el mapa para ver su gasto mensual.")
